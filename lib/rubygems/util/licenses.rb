# frozen_string_literal: true
require 'rubygems/text'

class Gem::Licenses
  extend Gem::Text

  NONSTANDARD = 'Nonstandard'.freeze

  # Software Package Data Exchange (SPDX) standard open-source software
  # license identifiers
  LICENSE_IDENTIFIERS = {
      '0BSD' => false,
      'AAL' => false,
      'ADSL' => false,
      'AFL-1.1' => false,
      'AFL-1.2' => false,
      'AFL-2.0' => false,
      'AFL-2.1' => false,
      'AFL-3.0' => false,
      'AGPL-1.0' => false,
      'AGPL-3.0' => true,
      'AGPL-3.0-only' => false,
      'AGPL-3.0-or-later' => false,
      'AMDPLPA' => false,
      'AML' => false,
      'AMPAS' => false,
      'ANTLR-PD' => false,
      'APAFML' => false,
      'APL-1.0' => false,
      'APSL-1.0' => false,
      'APSL-1.1' => false,
      'APSL-1.2' => false,
      'APSL-2.0' => false,
      'Abstyles' => false,
      'Adobe-2006' => false,
      'Adobe-Glyph' => false,
      'Afmparse' => false,
      'Aladdin' => false,
      'Apache-1.0' => false,
      'Apache-1.1' => false,
      'Apache-2.0' => false,
      'Artistic-1.0' => false,
      'Artistic-1.0-Perl' => false,
      'Artistic-1.0-cl8' => false,
      'Artistic-2.0' => false,
      'BSD-1-Clause' => false,
      'BSD-2-Clause' => false,
      'BSD-2-Clause-FreeBSD' => false,
      'BSD-2-Clause-NetBSD' => false,
      'BSD-2-Clause-Patent' => false,
      'BSD-3-Clause' => false,
      'BSD-3-Clause-Attribution' => false,
      'BSD-3-Clause-Clear' => false,
      'BSD-3-Clause-LBNL' => false,
      'BSD-3-Clause-No-Nuclear-License' => false,
      'BSD-3-Clause-No-Nuclear-License-2014' => false,
      'BSD-3-Clause-No-Nuclear-Warranty' => false,
      'BSD-4-Clause' => false,
      'BSD-4-Clause-UC' => false,
      'BSD-Protection' => false,
      'BSD-Source-Code' => false,
      'BSL-1.0' => false,
      'Bahyph' => false,
      'Barr' => false,
      'Beerware' => false,
      'BitTorrent-1.0' => false,
      'BitTorrent-1.1' => false,
      'Borceux' => false,
      'CATOSL-1.1' => false,
      'CC-BY-1.0' => false,
      'CC-BY-2.0' => false,
      'CC-BY-2.5' => false,
      'CC-BY-3.0' => false,
      'CC-BY-4.0' => false,
      'CC-BY-NC-1.0' => false,
      'CC-BY-NC-2.0' => false,
      'CC-BY-NC-2.5' => false,
      'CC-BY-NC-3.0' => false,
      'CC-BY-NC-4.0' => false,
      'CC-BY-NC-ND-1.0' => false,
      'CC-BY-NC-ND-2.0' => false,
      'CC-BY-NC-ND-2.5' => false,
      'CC-BY-NC-ND-3.0' => false,
      'CC-BY-NC-ND-4.0' => false,
      'CC-BY-NC-SA-1.0' => false,
      'CC-BY-NC-SA-2.0' => false,
      'CC-BY-NC-SA-2.5' => false,
      'CC-BY-NC-SA-3.0' => false,
      'CC-BY-NC-SA-4.0' => false,
      'CC-BY-ND-1.0' => false,
      'CC-BY-ND-2.0' => false,
      'CC-BY-ND-2.5' => false,
      'CC-BY-ND-3.0' => false,
      'CC-BY-ND-4.0' => false,
      'CC-BY-SA-1.0' => false,
      'CC-BY-SA-2.0' => false,
      'CC-BY-SA-2.5' => false,
      'CC-BY-SA-3.0' => false,
      'CC-BY-SA-4.0' => false,
      'CC0-1.0' => false,
      'CDDL-1.0' => false,
      'CDDL-1.1' => false,
      'CDLA-Permissive-1.0' => false,
      'CDLA-Sharing-1.0' => false,
      'CECILL-1.0' => false,
      'CECILL-1.1' => false,
      'CECILL-2.0' => false,
      'CECILL-2.1' => false,
      'CECILL-B' => false,
      'CECILL-C' => false,
      'CNRI-Jython' => false,
      'CNRI-Python' => false,
      'CNRI-Python-GPL-Compatible' => false,
      'CPAL-1.0' => false,
      'CPL-1.0' => false,
      'CPOL-1.02' => false,
      'CUA-OPL-1.0' => false,
      'Caldera' => false,
      'ClArtistic' => false,
      'Condor-1.1' => false,
      'Crossword' => false,
      'CrystalStacker' => false,
      'Cube' => false,
      'D-FSL-1.0' => false,
      'DOC' => false,
      'DSDP' => false,
      'Dotseqn' => false,
      'ECL-1.0' => false,
      'ECL-2.0' => false,
      'EFL-1.0' => false,
      'EFL-2.0' => false,
      'EPL-1.0' => false,
      'EPL-2.0' => false,
      'EUDatagrid' => false,
      'EUPL-1.0' => false,
      'EUPL-1.1' => false,
      'EUPL-1.2' => false,
      'Entessa' => false,
      'ErlPL-1.1' => false,
      'Eurosym' => false,
      'FSFAP' => false,
      'FSFUL' => false,
      'FSFULLR' => false,
      'FTL' => false,
      'Fair' => false,
      'Frameworx-1.0' => false,
      'FreeImage' => false,
      'GFDL-1.1' => true,
      'GFDL-1.1-only' => false,
      'GFDL-1.1-or-later' => false,
      'GFDL-1.2' => true,
      'GFDL-1.2-only' => false,
      'GFDL-1.2-or-later' => false,
      'GFDL-1.3' => true,
      'GFDL-1.3-only' => false,
      'GFDL-1.3-or-later' => false,
      'GL2PS' => false,
      'GPL-1.0' => true,
      'GPL-1.0+' => true,
      'GPL-1.0-only' => false,
      'GPL-1.0-or-later' => false,
      'GPL-2.0' => true,
      'GPL-2.0+' => true,
      'GPL-2.0-only' => false,
      'GPL-2.0-or-later' => false,
      'GPL-2.0-with-GCC-exception' => true,
      'GPL-2.0-with-autoconf-exception' => true,
      'GPL-2.0-with-bison-exception' => true,
      'GPL-2.0-with-classpath-exception' => true,
      'GPL-2.0-with-font-exception' => true,
      'GPL-3.0' => true,
      'GPL-3.0+' => true,
      'GPL-3.0-only' => false,
      'GPL-3.0-or-later' => false,
      'GPL-3.0-with-GCC-exception' => true,
      'GPL-3.0-with-autoconf-exception' => true,
      'Giftware' => false,
      'Glide' => false,
      'Glulxe' => false,
      'HPND' => false,
      'HaskellReport' => false,
      'IBM-pibs' => false,
      'ICU' => false,
      'IJG' => false,
      'IPA' => false,
      'IPL-1.0' => false,
      'ISC' => false,
      'ImageMagick' => false,
      'Imlib2' => false,
      'Info-ZIP' => false,
      'Intel' => false,
      'Intel-ACPI' => false,
      'Interbase-1.0' => false,
      'JSON' => false,
      'JasPer-2.0' => false,
      'LAL-1.2' => false,
      'LAL-1.3' => false,
      'LGPL-2.0' => true,
      'LGPL-2.0+' => true,
      'LGPL-2.0-only' => false,
      'LGPL-2.0-or-later' => false,
      'LGPL-2.1' => true,
      'LGPL-2.1+' => true,
      'LGPL-2.1-only' => false,
      'LGPL-2.1-or-later' => false,
      'LGPL-3.0' => true,
      'LGPL-3.0+' => true,
      'LGPL-3.0-only' => false,
      'LGPL-3.0-or-later' => false,
      'LGPLLR' => false,
      'LPL-1.0' => false,
      'LPL-1.02' => false,
      'LPPL-1.0' => false,
      'LPPL-1.1' => false,
      'LPPL-1.2' => false,
      'LPPL-1.3a' => false,
      'LPPL-1.3c' => false,
      'Latex2e' => false,
      'Leptonica' => false,
      'LiLiQ-P-1.1' => false,
      'LiLiQ-R-1.1' => false,
      'LiLiQ-Rplus-1.1' => false,
      'Libpng' => false,
      'MIT' => false,
      'MIT-CMU' => false,
      'MIT-advertising' => false,
      'MIT-enna' => false,
      'MIT-feh' => false,
      'MITNFA' => false,
      'MPL-1.0' => false,
      'MPL-1.1' => false,
      'MPL-2.0' => false,
      'MPL-2.0-no-copyleft-exception' => false,
      'MS-PL' => false,
      'MS-RL' => false,
      'MTLL' => false,
      'MakeIndex' => false,
      'MirOS' => false,
      'Motosoto' => false,
      'Multics' => false,
      'Mup' => false,
      'NASA-1.3' => false,
      'NBPL-1.0' => false,
      'NCSA' => false,
      'NGPL' => false,
      'NLOD-1.0' => false,
      'NLPL' => false,
      'NOSL' => false,
      'NPL-1.0' => false,
      'NPL-1.1' => false,
      'NPOSL-3.0' => false,
      'NRL' => false,
      'NTP' => false,
      'Naumen' => false,
      'Net-SNMP' => false,
      'NetCDF' => false,
      'Newsletr' => false,
      'Nokia' => false,
      'Noweb' => false,
      'Nunit' => true,
      'OCCT-PL' => false,
      'OCLC-2.0' => false,
      'ODbL-1.0' => false,
      'OFL-1.0' => false,
      'OFL-1.1' => false,
      'OGTSL' => false,
      'OLDAP-1.1' => false,
      'OLDAP-1.2' => false,
      'OLDAP-1.3' => false,
      'OLDAP-1.4' => false,
      'OLDAP-2.0' => false,
      'OLDAP-2.0.1' => false,
      'OLDAP-2.1' => false,
      'OLDAP-2.2' => false,
      'OLDAP-2.2.1' => false,
      'OLDAP-2.2.2' => false,
      'OLDAP-2.3' => false,
      'OLDAP-2.4' => false,
      'OLDAP-2.5' => false,
      'OLDAP-2.6' => false,
      'OLDAP-2.7' => false,
      'OLDAP-2.8' => false,
      'OML' => false,
      'OPL-1.0' => false,
      'OSET-PL-2.1' => false,
      'OSL-1.0' => false,
      'OSL-1.1' => false,
      'OSL-2.0' => false,
      'OSL-2.1' => false,
      'OSL-3.0' => false,
      'OpenSSL' => false,
      'PDDL-1.0' => false,
      'PHP-3.0' => false,
      'PHP-3.01' => false,
      'Plexus' => false,
      'PostgreSQL' => false,
      'Python-2.0' => false,
      'QPL-1.0' => false,
      'Qhull' => false,
      'RHeCos-1.1' => false,
      'RPL-1.1' => false,
      'RPL-1.5' => false,
      'RPSL-1.0' => false,
      'RSA-MD' => false,
      'RSCPL' => false,
      'Rdisc' => false,
      'Ruby' => false,
      'SAX-PD' => false,
      'SCEA' => false,
      'SGI-B-1.0' => false,
      'SGI-B-1.1' => false,
      'SGI-B-2.0' => false,
      'SISSL' => false,
      'SISSL-1.2' => false,
      'SMLNJ' => false,
      'SMPPL' => false,
      'SNIA' => false,
      'SPL-1.0' => false,
      'SWL' => false,
      'Saxpath' => false,
      'Sendmail' => false,
      'SimPL-2.0' => false,
      'Sleepycat' => false,
      'Spencer-86' => false,
      'Spencer-94' => false,
      'Spencer-99' => false,
      'StandardML-NJ' => true,
      'SugarCRM-1.1.3' => false,
      'TCL' => false,
      'TCP-wrappers' => false,
      'TMate' => false,
      'TORQUE-1.1' => false,
      'TOSL' => false,
      'UPL-1.0' => false,
      'Unicode-DFS-2015' => false,
      'Unicode-DFS-2016' => false,
      'Unicode-TOU' => false,
      'Unlicense' => false,
      'VOSTROM' => false,
      'VSL-1.0' => false,
      'Vim' => false,
      'W3C' => false,
      'W3C-19980720' => false,
      'W3C-20150513' => false,
      'WTFPL' => false,
      'Watcom-1.0' => false,
      'Wsuipa' => false,
      'X11' => false,
      'XFree86-1.1' => false,
      'XSkat' => false,
      'Xerox' => false,
      'Xnet' => false,
      'YPL-1.0' => false,
      'YPL-1.1' => false,
      'ZPL-1.1' => false,
      'ZPL-2.0' => false,
      'ZPL-2.1' => false,
      'Zed' => false,
      'Zend-2.0' => false,
      'Zimbra-1.3' => false,
      'Zimbra-1.4' => false,
      'Zlib' => false,
      'bzip2-1.0.5' => false,
      'bzip2-1.0.6' => false,
      'curl' => false,
      'diffmark' => false,
      'dvipdfm' => false,
      'eCos-2.0' => true,
      'eGenix' => false,
      'gSOAP-1.3b' => false,
      'gnuplot' => false,
      'iMatix' => false,
      'libtiff' => false,
      'mpich2' => false,
      'psfrag' => false,
      'psutils' => false,
      'wxWindows' => true,
      'xinetd' => false,
      'xpp' => false,
      'zlib-acknowledgement' => false,
  }.freeze

  # exception identifiers
  EXCEPTION_IDENTIFIERS = {
      '389-exception' => false,
      'Autoconf-exception-2.0' => false,
      'Autoconf-exception-3.0' => false,
      'Bison-exception-2.2' => false,
      'Bootloader-exception' => false,
      'CLISP-exception-2.0' => false,
      'Classpath-exception-2.0' => false,
      'DigiRule-FOSS-exception' => false,
      'FLTK-exception' => false,
      'Fawkes-Runtime-exception' => false,
      'Font-exception-2.0' => false,
      'GCC-exception-2.0' => false,
      'GCC-exception-3.1' => false,
      'LZMA-exception' => false,
      'Libtool-exception' => false,
      'Linux-syscall-note' => false,
      'Nokia-Qt-exception-1.1' => false,
      'OCCT-exception-1.0' => false,
      'Qwt-exception-1.0' => false,
      'WxWindows-exception-3.1' => false,
      'eCos-exception-2.0' => false,
      'freertos-exception-2.0' => false,
      'gnu-javamail-exception' => false,
      'i2p-gpl-java-exception' => false,
      'mif-exception' => false,
      'openvpn-openssl-exception' => false,
      'u-boot-exception-2.0' => false,
  }.freeze

  REGEXP = %r{
    \A
    (?:
      (?<license>
        #{Regexp.union(LICENSE_IDENTIFIERS.keys)}
      )\+?
      (?:\s WITH \s 
        (?<exception>
          #{Regexp.union(EXCEPTION_IDENTIFIERS.keys)}
        )
      )? | #{NONSTANDARD}
    )
    \Z
  }ox.freeze

  def self.match?(license)
    !REGEXP.match(license).nil?
  end

  def self.deprecated?(license)
    match = REGEXP.match(license)
    return unless match
    cap = match.names.map {|n| [n, match[n]]}.to_h
    (cap['license'] && LICENSE_IDENTIFIERS[cap['license']])\
    || (cap['exception'] && EXCEPTION_IDENTIFIERS[cap['exception']])
  end

  def self.suggestions(license)
    by_distance = LICENSE_IDENTIFIERS.keys.group_by do |identifier|
      levenshtein_distance(identifier, license)
    end
    lowest = by_distance.keys.min
    return unless lowest < license.size
    by_distance[lowest]
  end
end
